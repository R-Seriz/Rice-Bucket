<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rice Bucket</title>
  <script type="importmap">
            {
              "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.167.1/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.167.1/examples/jsm/",
				"@tweenjs/tween.js": "/static/js/node_modules/@tweenjs/tween.js/dist/tween.esm.js"
              }
            }
          </script>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">
</head>

<body class="no-scroll">
  <div class="navbar">
    <a class="active" href="{{ url_for('home') }}" style="text-decoration:none">Home</a>
    <a href="{{ url_for('about') }}" style="text-decoration:none">About</a>
    <a href="{{ url_for('upload') }}" style="text-decoration:none">Upload</a>
    <a href="{{ url_for('directory') }}" style="text-decoration:none">Directory</a>
  </div>

  <div class="container" id="CSSRender">
  </div>

  <div id="info">
    <div id="info-window">
      <div id="window-bar">
        Information
        <div class="button-group">
          <div class="button" onclick="minimizeWindow('info-window')">
            <div class="minimize"></div>
          </div>
          <div class="button" onclick="makeFullScreen('info-window')">
            <div class="full-screen-1"></div>
            <div class="full-screen-2"></div>
          </div>
          <div class="button" onclick="closeWindow('info-window')">
            <div class="close"></div>
          </div>
        </div>
      </div>
      <div id="info-text">
        Title<br>
        Author/s<br>
        Date<br>
        Description<br>
      </div>
    </div>
  </div>

  <div id="comments">
    <div id="comments-window">
      <div id="window-bar">
        Comments
        <div class="button-group">
          <div class="button" onclick="minimizeWindow('comments-window')">
            <div class="minimize"></div>
          </div>
          <div class="button" onclick="makeFullScreen('comments-window')">
            <div class="full-screen-1"></div>
            <div class="full-screen-2"></div>
          </div>
          <div class="button" onclick="closeWindow('comments-window')">
            <div class="close"></div>
          </div>
        </div>
      </div>
      <div id="user-comment-area">
      </div>
      <form method=post enctype=multipart/form-data class="comment-area" id="submittedComment">
        <div>
          <textarea id="user-comment" name="text" maxlength="500" oninput="updateCharCount()"></textarea>
          <input id="commentAuthor" type=text name="author" style="display:none" value="BOB">
          <input name="postid" id="postid" style="display:none">
        </div>
        <div class="actions">
          <input id="add-comment" type=submit value="Share Comment">
          <div id="char-counter">0/500</div>
        </div>
      </form>
    </div>
  </div>
  <script>
    const form = document.getElementById('submittedComment');
    form.onsubmit = (e) => {
      e.preventDefault();
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/comment");
      xhr.onload = function (event) {
        console.log(event.target.response);
      }
      // or onerror, onabort
      var formData = new FormData(form);
      xhr.send(formData);
    }

    function showInfoWindow(title, author, month, year, desc) {
      document.getElementById('info-window').style.display = 'block';;
      document.getElementById('info-text').innerHTML = `Title<br>${title}<br>
        Author/s<br>${author}<br>
        Date<br>${year}, ${month}<br>
        Description<br>${desc}`
    }

    function showCommentWindow(id) {
      document.getElementById('postid').value = id;
      const ca = document.getElementById("user-comment-area");

      var xhr = new XMLHttpRequest();
      xhr.open("get", `/comment/${id}`);
      xhr.onload = function (event) {
        ca.innerHTML = '';
        const comments = JSON.parse(event.target.response);
        for (let idx in comments) {
          var elem = document.createElement('div');
          elem.classList.add('added-comment-area');
          elem.innerHTML = `
          <div class="user-name">${comments[idx]['author']}</div>
          <div class="added-comment">${comments[idx]['text']}</div>`
          ca.appendChild(elem);
        }
        document.getElementById('comments-window').style.display = 'block';
      }
      xhr.send();
    }
  </script>

  <script type="module" src="/static/js/3dnavigator.js"></script>
</body>

<style>
  #info {
    position: absolute;
    top: 0px;
    left: 0px;
    z-index: 4;
  }

  #info-window {
    display: none;
    position: absolute;
    top: 0px;
    left: 0px;
    cursor: default;
    background-color: white;
    box-shadow: -2px -2px #e0dede, -2px 0 #e0dede, 0 -2px #e0dede, -4px -4px white, -4px 0 white, 0 -4px white, 2px 2px #818181, 0 2px #818181, 2px 0 #818181, 2px -2px #e0dede, -2px 2px #818181, -4px 2px white, -4px 4px black, 4px 4px black, 4px 0 black, 0 4px black, 2px -4px white, 4px -4px black;
    width: 19vw;
    display: none;
    overflow: auto;
  }

  #info-text {
    font-family: 'Chicago';
    font-size: 16px;
    padding: 5px;
  }

  #comments {
    position: absolute;
    top: 0px;
    left: 0px;
    z-index: 4;
  }

  #comments-window {
    display: none;
    position: absolute;
    top: 0px;
    left: 0px;
    cursor: default;
    background-color: white;
    box-shadow: -2px -2px #e0dede, -2px 0 #e0dede, 0 -2px #e0dede, -4px -4px white, -4px 0 white, 0 -4px white, 2px 2px #818181, 0 2px #818181, 2px 0 #818181, 2px -2px #e0dede, -2px 2px #818181, -4px 2px white, -4px 4px black, 4px 4px black, 4px 0 black, 0 4px black, 2px -4px white, 4px -4px black;
    width: 19vw;
    height: 600px;
  }

  #add-comment {
    height: 20px;
    width: 110px;
    background-color: #e0dede;
    border: none;
    box-shadow: -2px -2px #e0dede, -2px 0 #e0dede, 0 -2px #e0dede, -4px -4px white, -4px 0 white, 0 -4px white, 2px 2px #818181, 0 2px #818181, 2px 0 #818181, 2px -2px #e0dede, -2px 2px #818181, -4px 2px white, -4px 4px black, 4px 4px black, 4px 0 black, 0 4px black, 2px -4px white, 4px -4px black;
    font-family: JetBrains Mono, monospace;
    font-size: 12px;
    margin-top: 10px;
    margin-left: 4px;
  }

  #add-comment:active {
    box-shadow: -2px -2px #818181, -2px 0 #818181, 0 -2px #818181, -4px -4px black, -4px 0 black, 0 -4px black, 2px 2px #e0dede, 0 2px #e0dede, 2px 0 #e0dede, 2px -2px #818181, -2px 2px #e0dede, -4px 2px black, -4px 4px white, 4px 4px white, 4px 0 white, 0 4px white, 2px -4px black, 4px -4px white;
  }

  .added-comment-area {
    display: flex;
    align-items: center;
    padding: 10px;
    gap: 10px;
  }

  .added-comment {
    background-color: none;
    font-family: JetBrains Mono, monospace;
    font-size: 12px;
  }

  .user-name {
    background-color: none;
    font-family: JetBrains Mono, monospace;
    font-size: 12px;
    font-weight: bold;
  }

  #char-counter {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    color: #818181;
    margin-top: 10px;
  }

  .comment-area {
    position: absolute;
    bottom: 0px;
    left: 0px;
    height: 90px;
    width: calc(100% - 20px);
    background-color: rgb(192, 192, 192);
    border-top: 2px solid #818181;
    display: flex;
    flex-direction: column;
    align-items: left;
    text-align: left;
    justify-content: center;
    font-family: JetBrains Mono, monospace;
    font-size: 14px;
    padding: 10px;
  }

  #user-comment {
    width: calc(100% - 12px);
    height: 50px;
    background-color: white;
    outline: none;
    padding: 5px;
    text-align: left;
    vertical-align: top;
    resize: none;
  }

  #window-bar {
    height: 30px;
    width: calc(100% - 10px);
    background: linear-gradient(90deg, #000b7c, #377cc6);
    border-bottom: 2px solid rgb(192, 192, 192);
    float: left;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 16px;
    color: white;
    font-family: 'Chicago';
    padding-left: 10px;
    z-index: 10px;
  }

  .actions {
    display: flex;
    align-items: center;
    gap: 40%;
  }
</style>

<script>
  let windows = {};

  function initializeWindow(id) {
    const windowElement = document.getElementById(id);
    const rect = windowElement.getBoundingClientRect();

    windows[id] = {
      isDragging: false,
      isFullScreen: false,
      isMinimized: false,
      originalState: {
        width: windowElement.style.width,
        height: windowElement.style.height,
        top: rect.top + window.scrollY,
        left: rect.left + window.scrollX,
      },
      offsetX: 0,
      offsetY: 0,
    };

    windowElement.addEventListener('mousedown', (e) => {
      if (e.button !== 0) return;
      windows[id].isDragging = true;

      const rect = windowElement.getBoundingClientRect();
      windows[id].offsetX = e.clientX - rect.left;
      windows[id].offsetY = e.clientY - rect.top;

      windowElement.style.transition = "none";

      windowElement.style.position = "absolute";
      windowElement.style.left = `${e.clientX - windows[id].offsetX}px`;
      windowElement.style.top = `${e.clientY - windows[id].offsetY}px`;

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', stopDragging);
    })

    function onMouseMove(e) {
      if (!windows[id].isDragging) return;
      const newX = e.clientX - windows[id].offsetX;
      const newY = e.clientY - windows[id].offsetY;
      windowElement.style.left = `${newX}px`;
      windowElement.style.top = `${newY}px`;
    }

    function stopDragging() {
      windows[id].isDragging = false;
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', stopDragging);
    }
  }

  function minimizeWindow(id) {
    const windowElement = document.getElementById(id);
    const state = windows[id];
    const commentArea = windowElement.querySelector('.comment-area');
    const infoText = document.getElementById('info-text');

    if (!state.isMinimized) {
      state.originalState.height = windowElement.style.height;
      windowElement.style.height = '30px';

      if (id === 'info-window' && infoText) {
        infoText.style.display = 'none';
      }
      if (id === 'comments-window' && commentArea) {
        commentArea.style.display = 'none';
      }
    } else {
      windowElement.style.height = state.originalState.height;

      if (id === 'info-window' && infoText) {
        infoText.style.display = 'block';
      }
      if (id === 'comments-window' && commentArea) {
        commentArea.style.display = 'block';
      }
    }

    state.isMinimized = !state.isMinimized;
  }

  function makeFullScreen(id) {
    const windowElement = document.getElementById(id);
    const state = windows[id];
    if (!state.isFullScreen) {
      state.originalState = {
        width: windowElement.style.width,
        height: windowElement.style.height,
        top: windowElement.style.top,
        left: windowElement.style.left,
      };
      windowElement.style.position = 'fixed';
      windowElement.style.top = '4px';
      windowElement.style.left = '4px';
      windowElement.style.width = 'calc(100vw - 8px)';
      windowElement.style.height = 'calc(100vh - 8px)';
    } else {
      Object.assign(windowElement.style, state.originalState);
    }
    state.isFullScreen = !state.isFullScreen;
  }

  function closeWindow(id) {
    console.log('Close clicked for:', id);
    document.getElementById(id).style.display = 'none';
  }

  initializeWindow('info-window');
  initializeWindow('comments-window');

  function updateCharCount() {
    const textarea = document.getElementById("user-comment");
    const counter = document.getElementById("char-counter");
    const maxLength = textarea.getAttribute("maxlength");
    const currentLength = textarea.value.length;

    counter.textContent = `${currentLength}/${maxLength}`;
  }

</script>

</html>